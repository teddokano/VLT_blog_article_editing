電圧レベル変換．デジタル信号の電圧変換ってどうやればいいの？

# 電圧レベル・トランスレータ
デジタル回路同士をつなぐとき，単純に信号線を直結すればいい…と思いがちですが，実は「論理レベルの電圧」が合わないと，動作が不安定になったり，最悪の場合デバイスを破壊してしまうことがあります．
そんなときに便利に使えるのが電圧レベル・トランスレータ(Voltage Level Translator．または電圧レベル・シフタとも呼びます)です．

電圧レベル・トランスレータは，異なる電源電圧のデジタル回路間で信号をやり取りできるようにする回路です．
例えば，次のようなケースで必要になります [図1]．
3.3Vマイコン ↔︎ 5Vセンサー
1.8V FPGA ↔︎ 3.3V周辺デバイス

このブログでは，TTL，LVTTL，CMOSの電圧レベルの違いや，それを判断する上で重要なVOL/VOH/VIL/VIHの意味について解説し，さらに様々な変換の方法の中からどのような電圧レベル・トランスレータを選べばよいかを解説します．
特に特別な扱いが必要となる双方向オープンドレイン信号の変換について詳しく見てみます．

# デジタル信号
## 様々なデジタル信号

いわゆる「デジタル信号」は論理レベルの1と0を電気的に表現したものです．
この論理レベルの1と0を扱う回路設計方法には歴史的に様々なものがあります．
論理レベルを単純な電圧のHIGHとLOWで表現するものや，電圧の差を利用してHIGH/LOWを表現するものなどがあります．
単純なHIGH/LOWを5V/0Vで表すTTL．さらにそのTTLを低電圧化し3.3V/0Vで表すLVTTLなどバイポーラ・トランジスタ回路を基準に電圧レベルが決められたもの．
同様にバイポーラ・トランジスタを使いながらも高速化が図られた，負電源を使い低振幅で差動で動作論理レベルを実装したECL．
基準電圧を設けて低振幅のシングルエンド信号でHIGH/LOWを伝達するGTL．
また単純なHIGH/LOWでの表現でも低消費電力化を目的に開発された4000シリーズと呼ばれるCMOS汎用ロジックでは，HIGHレベルとして3V〜18Vを使うことができました．
https://en.wikipedia.org/wiki/Logic_family

このブログでは，上記のような様々な論理レベルの中でも，単純なHIGHとLOWの電圧で論理を表現するTTL(LVTTL)とCMOSの電圧レベルの扱いについて解説します．
その他の信号変換には専用チップが用いられるため，ここでは扱いません．

[図2]

## CMOSとTTL：単純な電圧のHIGHとLOWによる論理レベルの信号

デジタル回路に使われる単純な電圧のHIGHとLOWによる論理レベルの信号には，HIGHを電源電圧で，LOWを0Vとするものが一般的です．
電源電圧が異なってもHIGH/LOWの電圧レベルが同じであれば，そのまま信号をやり取りすることができます．

たとえばTTL(LVTTL)は入力される信号が2.0V以上であればHIGH，0.8V以下であればLOWと解釈します．このような取り決めがあるため，TTL信号であれば互いに電源電圧が異なってもHIGH/LOWの電圧レベルは変わりません．
いっぽう，CMOSは電源電圧の半分の電圧を基準にしてHIGH/LOWを定義します．このためCMOSは電源電圧が異なるとHIGH/LOWの電圧レベルも変わります[図3]．

## 出力電圧の規定：VOHとVOL

デジタル回路ではHIGHとLOWとして出力される電圧と，入力される信号をHIGHとLOWに判断する電圧が規定されています．
出力ではHIGH/LOWを出力する際の電流を考えておかねばなりません．
HIGH出力での最大流出電流時に保証できる電圧をVOH(min)，LOW出力での最大流入電流時に保証できる電圧をVOL(max)と呼びます．

VOH(min)は回路出力段の上側のトランジスタがONになったときに出力される電圧です．
このトランジスタには「ON抵抗」と呼ばれる抵抗分があります．
トランジスタから流れ出る電流が大きい場合，電流x抵抗で発生する電圧降下が大きくなりVOHは低くなってしまいます．
このため，あらかじめ想定される最大流出電流のときに保証できる最小の電圧がVOH(min)となります．
VOLはこの逆となります．回路出力段の下側のトランジスタがONになったとき，流れ込む電流が大きいと，トランジスタのON抵抗によって電圧が上がってしまいます．
このため，あらかじめ想定される最大流入電流のときに保証できる最大の電圧がVOL(max)となります．
[図]

## 入力電圧の規定：VIHとVIL

入力にはHIGHとLOWを判断するための電圧レベルがあります．VIH(min)とVIL(max)です．
電圧がVIH(min)以上であればHIGHと判断され，VIL(max)以下であればLOWと判断されます．

つまり出力と入力の関係は下式のようになっていなくてはなりません．

HIGHレベル： VOH(min) > VIH(min)
LOWレベル： VOL(max) < VIL(max)

この関係が守られていれば，出力側の回路は，次の入力側の回路に対してHIGH/LOWを正しく伝えることができます．
さらにこの「VOH(min) - VIH(min)」や「VIL(max) - VOL(max)」の差は「ノイズ・マージン」となり，ノイズ耐性が高くなります．

# 基本的な電圧レベル変換の方法：片方向信号の変換
## 電圧が違っても変換の必要がない例

『「VOH(min) > VIH(min)」かつ「VOL(max) < VIL(max)」』の関係が成り立つ場合には基本的には電圧レベル変換は必要ありません．
ただし出力電圧が入力側チップの電源電圧よりも高い場合には注意が必要です．

たとえばTTL(LVTTL)のVOH(min)は2.4V，VOL(max)は0.4Vです．VIH(min)/VIL(max)はそれぞれ2.0V/0.8Vなので問題なく接続できます．
しかし出力側が5V，入力側が3.3V電源を使うチップである場合には，入力側は「5Vトレラント入力」に対応していなければなりません．
5Vトレラント入力とは，5VのHIGH信号を3.3Vの電源電圧で動作するチップの入力に接続しても問題なく動作する入力のことです．
一般的なチップの入力には静電気対策のためのESD保護回路が入っていますが，このESD保護回路が次の図のような回路で構成されていると5Vを入力した際に入力から3.3Vの電源に電流が逆流してしまい，チップを破壊してしまうことがあります．
このような問題を起こさないための対策が取られた入力が5Vトレラント入力です．

[図9]のようなESD保護ダイオードは，入力側チップの電源が切られている時にも問題を引き起こします．
チップごとに個別に電源のON/OFF管理を行うようなシステムの場合，入力側チップがOFFになっているにも関わらず出力側の信号が電源に回り込み，入力側チップを動作させてしまうことがあります．

## オープンドレイン出力による変換

電圧レベル変換チップを用いなくても，簡単に電圧レベル合わせを行う方法があります．
HIGH側の出力をオープンドレイン出力にすることで，入力側の電圧に合わせる方法です．
オープンドレインはデジタル回路の出力段の上側のトランジスタがない構成のもので，入力側チップの電源電圧に接続されたプルアップ抵抗によってHIGHの電圧を得ます[図10]．

オープンドレインは単純で安価な方法ですが，いくつかの注意点があります．
まず出力側がオープンドレイン出力が可能なものである必要があります．多くのマイコンのGPIOピンなどでは設定によってこの出力が可能です．
もしオープンドレイン出力ではない(プッシュプル出力など)場合には，外付けのトランジスタなどを使ってオープンドレイン出力に変換する必要があります．

さらにプルアップ抵抗の選択も重要です．
プルアップ抵抗はHIGHの電圧を得るために必要な抵抗ですが，抵抗値が小さすぎるとLOW出力時に流れる電流が大きくなり，消費電力が増える上にVOLの上昇を招いてしまいます．
逆に大きすぎると配線とピンによる容量の影響を受け，LOWからHIGHへの立ち上がりが遅くなってしまい，通信速度の低下が起こります．．

## 標準ロジック(汎用ロジック)チップを用いた変換

単純な電圧レベル変換であれば標準ロジックを用いる方法もあります．
たとえばNexperia社の74AVCH4T245は4ビットの双方向レベル変換を行うことができるCMOS汎用ロジックチップです．
このチップでは0.8V〜3.6Vの信号を変換することができ，信号の方向をDIRピンによって切り替えることもできます[図11]．
信号速度は変換を行う電圧にも依存しますが，100M〜380Mbps程度に対応可能です．
![74AVCH4T245](https://assets.nexperia.com/documents/data-sheet/74AVCH4T245.pdf)


## 電圧レベル・トランスレータを用いた変換

電圧レベル・トランスレータは，異なる電圧のデジタル信号を変換するために特化した専用チップです．
これまでに紹介した方法は主に一方向のみの変換を行うもの，あるいは方向の切り替えが必要なものでした [図13]．
専用品では信号方向を自動検出するため双方向の変換が可能なものがあります．
このようなチップを使うことで，たとえばI²Cのような双方向通信を行うバスの電圧レベル変換を容易に行うことができます．

# 電圧レベル・トランスレータ：双方向信号の変換

## トランジスタによる変換：単純なMOSトランジスタによる双方向変換

I²Cのような信号の方向がダイナミックに変わるような通信には，方向が自動で切り替わる「双方向の電圧レベル変換」が必要です．
このような信号の場合，信号の方向の切り替えを外部から制御するのは難しく，またオープンドレイン信号であるため，オープンドレインの標準ロジック・バッファを互いに違う向きに接続するようなことができません．
このような信号には，これまで単純な回路が用いられることがありました．
最も簡単な例は	MOSトランジスタを使った方法をその例として挙げます[図14]．

この図はI²Cの仕様書version2.1(2000年)から引用したもので，3.3Vと5Vの信号を2本の信号にそれぞれ1個のMOSトランジスタを用いる例です．
このような変換例は後述する問題点があるため，現在のI²Cの仕様書からは削除されていますが，原理を理解するために紹介します．
![I²C](https://www.nxp.com/docs/en/user-guide/UM10204.pdf)

SDAとSCLと呼ばれるI²Cの信号線は，どちらもオープンドレイン出力の双方向信号となっています．
3.3V側と5V側にそれぞれプルアップ抵抗が接続されています．
この回路では3.3V側，5V側の信号がHIGHである場合，このトランジスタのゲート(g)とソース(s)間は同電位となるため，ソース(s)とドレイン(d)OFF状態となって互いの接続が切れた状態に置かれます．
この状態で3.3VがLOWに変化すると，3.3V側のトランジスタ(のsとdの間)がONになり，5V側の信号もLOWになります．
3.3V側がHIGHで5V側がLOWに変化した場合には，まず3.3V側から5V側への寄生ダイオード(ボディ・ダイオード)によってソース(s)の電圧が降下し，これによってトランジスタがONになり，3.3V側の信号もLOWになります．

このように非常に単純な仕組みで電圧レベル変換ができるのですが，ここには問題もあります．
トランジスタのバラツキによって信号の閾値にも影響すること．
さらに今日ではより低い電源電圧を使用するチップが増えてきていることにより，このような回路では十分なゲート(g)とソース(s)間電圧(Vgs)が得られず，使用できない例が増えてきているためです．

## トランジスタによる変換：単純なトランジスタ構造を持つ専用品による双方向変換

PCA9306，NVT20xxシリーズは双方向信号の変換に特化した電圧レベル・トランスレータです．
これらのチップでは複数の信号線をまとめて扱うことができます．
これらのチップは同じ内部構造を持ち，プルアップ抵抗は，変換の電圧差が1V以上のであれば電圧の高い側だけに接続すれば良いようになっています．

[図15]はその内部構造と外部チップの接続を示したものです．
このチップ内部には信号線数(ビット数)+1個のMOSトランジスタが内蔵されています．
各トランジスタはソースとドレインが可換の構造となっているのも特徴です．
1個はリファレンス・トランジスタと呼ばれ，残りの信号を伝達するための経路のトランジスタはパス・トランジスタと呼ばれます．

回路を見てみると，リファレンス・トランジスタのゲートとドレイン間はショートされており，200kΩの抵抗を介して高い電圧側の電源に接続されています．
リファレンス・トランジスタの残りの端子：ソースは低電圧側の電源に接続されています．
このような接続により，リファレンス・トランジスタは1個のダイオードとなっており，ゲート電圧は低電圧側の電源よりもダイオード1個分高い電圧となります．

残りのパス・トランジスタはドレイン側が高い電圧側の信号線と1kΩのプルアップ抵抗に，ソース側は低い電圧側の信号線，さらにゲートはリファレンス・トランジスタのゲートに接続されています．
このような状態において，パス・トランジスタの高い側，低い側の信号がどちらもHIGHになっている時，高い側は1kΩによってプルアップされて電圧となります．
いっぽう，低い電圧側の端子(ソース端子)は，いわゆる「ソースフォロワ」となっていて，ゲートに印加されている電圧よりトランジスタをONにするために必要なVgs分だけ低い電圧が現れます．
つまり低電圧側の電源と同じ電圧となります．

高低のどちらかの信号がLOWになると，ゲートと信号端子の電圧差によりトランジスタがONになり，反対側の端子もLOWになります．

このシリーズで扱える信号速度は，プルアップと信号線の容量の影響を受けます．データシートでは，PCA9306は2MHzまで．
NVT20xxシリーズでは192Ωのプルアップ抵抗を使用し，容量50pFの条件で最大33MHzまでの信号速度に対応可能とされています．
1MHz程度の信号であれば，プルアップ抵抗や容量をあまり気にしなくても(通常I²Cで使うような範囲内を想定)で問題なく動作します．
しかしこのチップをプッシュプルのより高速な信号を扱う場合には特製の把握と慎重な部品選択が必要になります．

## 高速化を図った双方向オープンドレイン信号変換チップ

高速化を図った双方向オープンドレイン信号変換チップとして，NTS030xを紹介します．
このチップは2ビットの双方向信号変換を行うことができ，オープンドレイン信号であれば2Mbps(1MHz)，プッシュプル信号であれば20Mbps(10MHz)の信号に対応可能です．

[図16]はNTS030xの信号1ビット分の内部構造です．
図ではT3のトランジスタがパス・トランジスタとなっており，ゲート端子バイアス電圧がかけられているので，AとBと書かれた信号のどちらかがLOWとなった時にONとなります．
AとBの両方がHIGHの時はT3がOFFになり，AとBはそれぞれの電源に比較的大きいプルアップ抵抗(10kΩ)で接続されているのでそれぞれの電圧となります．

このチップにはT3のほかにT1とT2が存在しています．
このT1とT2は「エッジレート・アクセラレータ」と呼ぶ機能のために使われます．
このうちの片方，T1に注目します．
T1はA側に置かれ，ソーズ端子はA信号に，ドレイン端子はA側電源に接続されています．ゲート端子はこれを制御する「ONE-SHOT AND SLEW RATE CONTROL」と書かれたブロックに接続されています．
「ONE-SHOT AND SLEW RATE CONTROL」ブロックは反対側のB信号に接続されていて，B側の信号のLOWからHIGHへの変化を検出．この時に一時的にT1をONにして，A側の信号のHIGHへの変化を加速します．
さらにT1をONにする際のスルーレートも制御されているので，急な電流増加によるリンギングを抑えることも考慮されています．
このようにして，信号の立ち上がりを速くすることで，より高速な信号を扱うことができるようになっています．

もういっぽうのT2はこの同じ仕組みが逆方向に作られており，B側信号にも適用されるようになっています．

このNTSシリーズにはもう一つの使いやすい点があります．
ここまで説明したMOSトランジスタ単体やPCA9306/NVT20xxの場合，どちらかの電源がOFFになった場合，他方の信号に影響してしまうという問題がありました．
NTS030xではこの問題を解決するために，両方の電源がONになっていない場合は，互いに影響が出ないように信号ピンをハイ・インピーダンス状態とするよう動作します．
このような機能を使うことにより，システムの電源を部分的にON/OFF制御するような使い方が可能になります．

さらにこのNTSシリーズをプッシュぷる信号だけで使う場合のより高速なオプションとしてNTB010xシリーズがあります．

## バッファによる変換

もう一つの双方向信号の変換方法として，専用品のバッファを使う方法があります．
バッファの本来の目的は，駆動能力増強や接続している信号線の容量の分離などですが，電圧の変換に対応した製品も存在します．

双方向のオープンドレイン信号を相互にバッファするには，単純なバッファでは動作させることができないため，I²C用として様々なバッファ製品が用意されています．
バッファについての詳細はまた次の機会に解説します．

# まとめ




# 参考資料

I2C バス仕様およびユーザーマニュアル (Rev5.0 日本語版)
https://www.nxp.com/docs/ja/user-guide/UM10204.pdf

I2C バス仕様およびユーザーマニュアル (Rev7.0 英語版)
https://www.nxp.com/docs/en/user-guide/UM10204.pdf

NXPコミュニティ・ブログ：I²Cハードウェア・デバッグ
https://community.nxp.com/t5/NXP-Tech-Blog/I-C-%E3%83%8F%E3%83%BC%E3%83%89%E3%82%A6%E3%82%A7%E3%82%A...

NXPコミュニティ・ブログ：SPIバスの概要
https://community.nxp.com/t5/NXP-Tech-Blog/SPI%E3%83%90%E3%82%B9%E3%81%AE%E6%A6%82%E8%A6%81/ba-p/203...

PCA9306の中身と動作
https://qiita.com/teddokano/items/2ecc1f65d7cd45e78b49
 

[初出：インターフェース 2024年3月号(CQ出版)「I2C＆SPIをゼロから作る②…I2Cの通信規格」p55-61．ブログ掲載にあたり通信仕様解説部分を抜粋，加筆修正]

変更履歴：
2025-08-xx：初版
=========================
本投稿の「Comment」欄にコメントをいただいても，現在返信に対応しておりません．
お手数をおかけしますが，お問い合わせの際には，NXP代理店，もしくはNXPまでお問い合わせください．
