電圧レベル変換．デジタル信号の電圧変換ってどうやればいいの？

# 電圧レベル・トランスレータ
デジタル回路同士をつなぐとき，単純に信号線を直結すればいい…と思いがちですが，実は「論理レベルの電圧」が合わないと、動作が不安定になったり、最悪の場合デバイスを破壊してしまうことがあります。
そんなときに便利に使えるのが電圧レベル・トランスレータ(Voltage Level Translatorまたは電圧レベル・シフタ)です．
この記事では、TTL、LVTTL、CMOSの電圧レベルの違いや、それを判断する上で重要なVOL/VOH/VIL/VIHの意味について解説し，さらに様々な変換の方法の中から、どのような電圧レベル・トランスレータを選べばよいかを解説します．

電圧レベル・トランスレータは、異なる電源電圧のデジタル回路間で信号をやり取りできるようにする回路です。
例えば，次のようなケースで必要になります．
3.3Vマイコン ↔︎ 5Vセンサー
1.8V FPGA ↔︎ 3.3V周辺デバイス

# デジタル信号
## 様々なデジタル信号

いわゆる「デジタル信号」は論理レベルの1と0を電気的に表現したものです．
この論理レベルの1と0を扱う回路設計方法には歴史的に様々なものがあります．
論理レベルを単純な電圧のHIGHとLOWで表現するものや，電圧の差を利用してHIGH/LOWを表現するものなどがあります．
単純なHIGH/LOWを5V/0Vで表すTTL．さらにそのTTLを低電圧化し3.3V/0Vで表すLVTTLなどバイポーラ・トランジスタ回路を基準に電圧レベルが決められたもの．
同様にバイポーラ・トランジスタを使いながらも高速化が図られた，負電源を使い低振幅で差動で動作論理レベルを実装したECL．
基準電圧を設けて低振幅のシングルエンド信号でHIGH/LOWを伝達するGTL．
また単純なHIGH/LOWでの表現でも低消費電力化を目的に開発された4000シリーズと呼ばれるCMOS汎用ロジックでは，HIGHレベルとして3V〜18Vを使うことができました．
https://en.wikipedia.org/wiki/Logic_family

このブログでは，上記のような様々な論理レベルの中でも，単純なHIGHとLOWの電圧で論理を表現するTTL(LVTTL)とCMOSの電圧レベルの扱いについて解説します．
その他の信号変換には専用チップが用いられるため，ここでは扱いません．

## CMOSとTTL：単純な電圧のHIGHとLOWによる論理レベルの信号

デジタル回路に使われる単純な電圧のHIGHとLOWによる論理レベルの信号には，HIGHを電源電圧で，LOWを0Vとするものが一般的です．
電源電圧が異なってもHIGH/LOWの電圧レベルが同じであれば，そのまま信号をやり取りすることができます．

たとえばTTL(LVTTL)は入力される信号が2.0V以上であればHIGH，0.8V以下であればLOWと解釈します．このような取り決めがあるため，TTL信号であれば互いに電源電圧が異なってもHIGH/LOWの電圧レベルは変わりません．
いっぽう，CMOSは電源電圧の半分の電圧を基準にしてHIGH/LOWを定義します．このためCMOSは電源電圧が異なるとHIGH/LOWの電圧レベルも変わります．

## 出力電圧の規定：VOHとVOL

デジタル回路ではHIGHとLOWとして出力される電圧と，入力される信号をHIGHとLOWに判断する電圧が規定されています．
出力ではHIGH/LOWを出力する際の電流を考えておかねばなりません．
HIGH出力での最大流出電流時に保証できる電圧をVOH(min)，LOW出力での最大流入電流時に保証できる電圧をVOL(max)と呼びます．

VOH(min)は回路出力段の上側のトランジスタがONになったときに出力される電圧です．
このトランジスタには「ON抵抗」と呼ばれる抵抗分があります．
トランジスタから流れ出る電流が大きい場合，電流x抵抗で発生する電圧降下が大きくなりVOHは低くなってしまいます．
このため，あらかじめ想定される最大流出電流のときに保証できる最小の電圧がVOH(min)となります．
VOLはこの逆となります．回路出力段の下側のトランジスタがONになったとき，流れ込む電流が大きいと，トランジスタのON抵抗によって電圧が上がってしまいます．
このため，あらかじめ想定される最大流入電流のときに保証できる最大の電圧がVOL(max)となります．
[図]

## 入力電圧の規定：VIHとVIL

入力にはHIGHとLOWを判断するための電圧レベルがあります．VIH(min)とVIL(max)です．
電圧がVIH(min)以上であればHIGHと判断され，VIL(max)以下であればLOWと判断されます．

つまり出力と入力の関係は下式のようになっていなくてはなりません．

HIGHレベル： VOH(min) > VIH(min)
LOWレベル： VOL(max) < VIL(max)

この関係が守られていれば，出力側の回路は，次の入力側の回路に対してHIGH/LOWを正しく伝えることができます．
さらにこの「VOH(min) - VIH(min)」や「VIL(max) - VOL(max)」の差は「ノイズ・マージン」となり，ノイズ耐性が高くなります．

# 基本的な電圧レベル変換の方法
## 電圧が違っても変換の必要がない例

『「VOH(min) > VIH(min)」かつ「VOL(max) < VIL(max)」』の関係が成り立つ場合には基本的には電圧レベル変換は必要ありません．
ただし出力電圧が入力側チップの電源電圧よりも高い場合には注意が必要です．

たとえばTTL(LVTTL)のVOH(min)は2.4V，VOL(max)は0.4Vです．VIH(min)/VIL(max)はそれぞれ2.0V/0.8Vなので問題なく接続できます．
しかし出力側が5V，入力側が3.3V電源を使うチップである場合には，入力側は「5Vトレラント入力」に対応していなければなりません．
5Vトレラント入力とは，5VのHIGH信号を3.3Vの電源電圧で動作するチップの入力に接続しても問題なく動作する入力のことです．
一般的なチップの入力には静電気対策のためのESD保護回路が入っていますが，このESD保護回路が次の図のような回路で構成されていると5Vを入力した際に入力から3.3Vの電源に電流が逆流してしまい，チップを破壊してしまうことがあります．
このような問題を起こさないための対策が取られた入力が5Vトレラント入力です．

図のようなESD保護ダイオードは、入力側チップの電源が切られている時にも問題を引き起こします．
チップごとに個別に電源のON/OFF管理を行うようなシステムの場合，入力側チップがOFFになっているにも関わらず出力側の信号が電源に回り込み，入力側チップを動作させてしまうことがあります．

## オープンドレイン出力による変換

電圧レベル変換チップを用いなくても，簡単に電圧レベル合わせを行う方法があります．
HIGH側の出力をオープンドレイン出力にすることで，入力側の電圧に合わせる方法です．
オープンドレインはデジタル回路の出力段の上側のトランジスタがない構成のもので，入力側チップの電源電圧に接続されたプルアップ抵抗によってHIGHの電圧を得ます．

オープンドレインは単純で安価な方法ですが，いくつかの注意点があります．
まず出力側がオープンドレイン出力が可能なものである必要があります．多くのマイコンのGPIOピンなどでは設定によってこの出力が可能です．
もしオープンドレイン出力ではない(プッシュプル出力など)場合には，外付けのトランジスタなどを使ってオープンドレイン出力に変換する必要があります．

さらにプルアップ抵抗の選択も重要です．
プルアップ抵抗はHIGHの電圧を得るために必要な抵抗ですが，抵抗値が小さすぎるとLOW出力時に流れる電流が大きくなり，消費電力が増える上にVOLの上昇を招いてしまいます．
逆に大きすぎると配線とピンによる容量の影響を受け，LOWからHIGHへの立ち上がりが遅くなってしまい，通信速度の低下が起こります．．

## 標準ロジック(汎用ロジック)チップを用いた変換

単純な電圧レベル変換であれば標準ロジックを用いる方法もあります．
たとえばNexperia社の74AVCH4T245は4ビットの双方向レベル変換を行うことができるCMOS汎用ロジックチップです．
このチップでは0.8V〜3.6Vの信号を変換することができ，信号の方向をDIRピンによって切り替えることもできます．
信号速度は変換を行う電圧にも依存しますが，100M〜380Mbps程度に対応可能です．
![74AVCH4T245](https://assets.nexperia.com/documents/data-sheet/74AVCH4T245.pdf)


# 電圧以外に考慮すべきポイント

## 信号の方向 (片方向・双方向・方向の切替)
## 速度

