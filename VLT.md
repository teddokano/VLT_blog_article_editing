電圧レベル変換．デジタル信号の電圧変換ってどうやればいいの？

# 電圧レベル・トランスレータ
デジタル回路同士をつなぐとき，単純に信号線を直結すればいい…と思いがちですが，実は「論理レベルの電圧」が合わないと、動作が不安定になったり、最悪の場合デバイスを破壊してしまうことがあります。
そんなときに便利に使えるのが電圧レベル・トランスレータ(Voltage Level Translatorまたは電圧レベル・シフタ)です．
この記事では、TTL、LVTTL、CMOSの電圧レベルの違いや、それを判断する上で重要なVOL/VOH/VIL/VIHの意味について解説し，さらに様々な変換の方法の中から、どのような電圧レベル・トランスレータを選べばよいかを解説します．

電圧レベル・トランスレータは、異なる電源電圧のデジタル回路間で信号をやり取りできるようにする回路です。
例えば，次のようなケースで必要になります．
3.3Vマイコン ↔︎ 5Vセンサー
1.8V FPGA ↔︎ 3.3V周辺デバイス

# デジタル信号
## 様々なデジタル信号

いわゆる「デジタル信号」は論理レベルの1と0を電気的に表現したものです．
この論理レベルの1と0を扱う回路設計方法には歴史的に様々なものがあります．
論理レベルを単純な電圧のHIGHとLOWで表現するものや，電圧の差を利用してHIGH/LOWを表現するものなどがあります．
単純なHIGH/LOWを5V/0Vで表すTTL．さらにそのTTLを低電圧化し3.3V/0Vで表すLVTTLなどバイポーラ・トランジスタ回路を基準に電圧レベルが決められたもの．
同様にバイポーラ・トランジスタを使いながらも高速化が図られた，負電源を使い低振幅で差動で動作論理レベルを実装したECL．
基準電圧を設けて低振幅のシングルエンド信号でHIGH/LOWを伝達するGTL．
また単純なHIGH/LOWでの表現でも低消費電力化を目的に開発された4000シリーズと呼ばれるCMOS汎用ロジックでは，HIGHレベルとして3V〜18Vを使うことができました．
https://en.wikipedia.org/wiki/Logic_family

このブログでは，上記のような様々な論理レベルの中でも，単純なHIGHとLOWの電圧で論理を表現するTTL(LVTTL)とCMOSの電圧レベルの扱いについて解説します．
その他の信号変換には専用チップが用いられるため，ここでは扱いません．

## CMOSとTTL

デジタル回路に使われる単純な電圧のHIGHとLOWによる論理レベルの信号には，HIGHを電源電圧で，LOWを0Vとするものが一般的です．
電源電圧が異なってもHIGH/LOWの電圧レベルが同じであれば，そのまま信号をやり取りすることができます．

たとえばTTL(LVTTL)は2.0V以上をHIGH，0.8V以下をLOWと定義しています．このため，TTL信号であれば互いに電源電圧が異なってもHIGH/LOWの電圧レベルは変わりません．
いっぽう，CMOSは電源電圧の半分の電圧を基準にしてHIGH/LOWを定義します．このためCMOSは電源電圧が異なるとHIGH/LOWの電圧レベルも変わります．



先に述べたように汎用ロジックでよく使われるHIGHの電圧の多くはは5Vという時代がありました．
その後，低消費電力化や高速化を実現するために，より低い電源電圧(主に3.3V)で動作させるLVTTLが出てきます．しかしこの場合のHIGH/LOWレベルはTTLと同様の2.0V/0.8Vのままでした．
さらに時代が進むとより低い電圧を使う様々なチップが登場します．
たとえば1.8Vの電源電圧で動作するチップではHIGH/LOWの電圧レベルは1.2V/0.3Vとなります．
このように，デジタル信号の電圧レベルは使用するチップによって異なることがあります．	


## 単純な電圧のHIGHとLOWによる論理レベル

### チップごとの電源電圧が違えば，デジタル信号の電圧も変わる

今日の様々なチップを組み合わせて使うシステムでは，それぞれのチップに必要な電源電圧は互いに異なる場合が多く，「これらをすべて3.3Vで統一して使う」ようなことは困難でしょう．
また消費電力を抑える目的で各チップに最適な電源電圧を選択することも必要です．
今日の高機能なプロセッサでは1Vを下回る電源電圧で動作するものもあります．かたや古くから使われている周辺チップにはまだに5Vで動作するものもあります．


これは例えば

TTLのように電源電圧が違ってもHIGH/LOWの電圧レベルは変わらなければ，チップ同士での互いの信号のやりとりには問題は起きません．
しかしCMOSの場合には電源電圧に応じてHIGH/LOWの電圧レベルが変わるため，その電圧差を考えておかなくてはなりません．




回路同士の接続にはこの信号電圧が合っていないと，期待通りの動作をしなかったり，最悪の場合には破壊してしまうこともあります．

信号の入出力レベルは，各チップで定義されており，それぞれのチップで異なります．
信号の入出力レベルは，VOH/VOL/VIH/VILと呼ばれる電圧レベルで定義されます．

VOL(max)：LOW-output Voltage (minimum)
出力が“Low”のときに保証される最大電圧

VOH(min)：HIGH-output Voltage (maximum)
出力が“High”のときに保証される最小電圧

VIL(max)：LOW-input Voltage (maximum)
入力が“Low”と認識される最大電圧

VIH(min)：HIGH-input Voltage (minimum)
入力が“High”と認識される最小電圧

これらの電圧レベルは，チップの仕様書に記載されています．




### 通信を行うには信号のレベル合わせが必要

互いのチップでHIGH/LOWの電圧レベルが異なる場合には，そのレベルを合わせる必要があります．
たとえば3.3Vの電源電圧で動作するチップと1.8Vの電源電圧で動作するチップがある場合，3.3Vのチップの出力信号を1.8Vのチップの入力に接続すると，3.3VのHIGH信号は1.8Vのチップの入力に対してはHIGHと認識されません．
このような場合には，3.3VのHIGH信号を1.8VのHIGH信号に変換する必要があります．
このような電圧レベルを合わせるための回路を「レベル変換回路」と呼びます．

## レベル合わせを行う方法
### 信号の方向
レベル変換回路を使う場合，まずは信号の方向を考	える必要があります．
レベル変換回路は信号の方向によって「片方向」と「双方向」の2種類に分けることができます．
片方向のレベル変換回路は，信号の方向が一方だけである場合に使います．
たとえば3.3Vのチップの出力信号を1.8Vのチップの入力に接続する場合などです．
この場合，3.3Vのチップの出力信号を1.8Vのチップの入力に接続するためのレベル変換回路が必要です．
一方，双方向のレベル変換回路は，信号の方向が両方に向く場合に使います．
たとえば3.3Vのチップの出力信号を1.8Vのチップの入力に接続し，さらに1.8Vのチップの出力信号を3.3Vのチップの入力に接続する場合などです．
この場合，3.3Vのチップの出力信号を1.8Vのチップの入力に接続するためのレベル変換回路と，
1.8Vのチップの出力信号を3.3Vのチップの入力に接続するためのレベル変換回路が必要です．
このような場合には，双方向のレベル変換回路を使うことができます．	
### 速度
レベル変換回路を使う場合，信号の速度も考慮	する必要があります．
レベル変換回路は信号のレベルを変換するために，信号の遅延が発生します．
この遅延はレベル変換回路の種類によって異なります．
たとえば，単純なダイオードを使ったレベル変換回路では，信号の遅延は数十ナノ秒程度です．
一方，トランジスタを使ったレベル変換回路では，信号の遅延は数百ナノ秒程度になります．
このため，レベル変換	回路を使う場合には，信号の速度を考慮する必要があります．


## 特殊な例：TTLとCMOSの組み合わせ
### 5Vトレラント入力
しかしもし，たとえば電源電圧5VのTTLチップと電源電圧3.3VのCMOSチップを組み合わせて使う場合，これらのチップ間で信号をやりとりするためには，それぞれのチップのHIGH/LOW電圧が互いに適合しているためそのまま接続できる場合があります．


** コラム **  
 特殊な例 TTLとCMOSの組み合わせ
しかしもし，たとえば電源電圧5VのTTLチップと電源電圧3.3VのCMOSチップを組み合わせて使う場合，これらのチップ間で信号をやりとりするためには，それぞれのチップのHIGH/LOW電圧が互いに適合しているためそのまま接続できる場合があります．
ただし「場合がある」としたのは，5V側のチップの出力を3.3V側のチップの入力に接続する場合には「5Vトレラント入力」になっている必要があるためです．
5Vトレラント入力とは，5VのHIGH信号を3.3Vの電源電圧で動作するチップの入力に接続しても問題なく動作する入力のことです．
たとえば一般的なチップの入力には静電気対策のためのESD保護回路が入っていますが，このESD保護回路が次の図のような回路で構成されていると5Vを入力した際に入力から3.3Vの電源に電流が逆流してしまい，チップを破壊してしまうことがあります．
このような問題を起こさないための対策が取られた入力が5Vトレラント入力です．

** コラム **  
余談ですが，この単純な入力と電源間のダイオードによるESD保護回路は入力側チップの電源が切られている時にも問題を引き起こします．チップごとに個別に電源のON/OFF管理を行うような場合に，出力側の信号が電源に回り込み，入力側チップを動作させてしまうことがあります．
3.3Vのマイコンが動作中に，その出力信号によって，電源が供給されてない3.3Vのチップを動作させてしまうような，そんな現象が発生します．


# 電圧以外に考慮すべきポイント

## 信号の方向 (片方向・双方向・方向の切替)
## 速度

